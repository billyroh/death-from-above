<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0 auto;
  padding: 60px;
  max-width: 1000px;
  min-width: 320px;
}

h1, h2 {
  font-weight: 300;
}

h1, h2, p {
  text-align: center;
}

.map {
  width: 100%;
  height: 600px;
  display: block;
  border: 1px solid rgba(0, 0, 0, 0.3);
}

.background {
  fill: none;
  pointer-events: all;
}

.feature {
  fill: #ccc;
  /*cursor: pointer;*/
}

circle {
  
}

.tooltip {
  width: 300px;
  height: 300px;
  background-color: red;
}

circle.strike, circle.timeline-circle {
  fill: rgb(200, 18, 18);
  opacity: 0.2;
  cursor: pointer;
  -webkit-transition: all 150ms;
  transition: all 150ms;
}

.feature.active {
  
}

.mesh {
  fill: none;
  stroke: #fff;
  stroke-width: 0.5px;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.country-name {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  fill: #000;
  opacity: 0.3;
  margin-left: -10px;
  font-size: 11px;
  text-transform: uppercase;
  cursor: default;
}

/* Timeline stuff */ 

.timeline {
  width: 100%;
  height: 30px;
  margin-top: 10px;
}

.timeline-by-country {
  width: 100%;
  height: 1000px;
}

.axis path,
.axis line {
  fill: none;
  stroke: black;
  shape-rendering: crispEdges;
}

.axis path {
  stroke: none;
}

.axis text {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 11px;
  cursor: default;
}

circle.not-applicable {
  opacity: 0;
  /*display: none;*/
}


/* Tooltip shit */

.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}

</style>
<body>
<div class="data-type-selector-wrapper">
  <select class="data-type-selector">
    <option class="data-type" value="deaths_max" selected="selected">Maximum Death Estimate</option>
    <option class="data-type" value="deaths_min">Minimum Death Estimate</option>
    <option class="data-type" value="civilians">Civilians</option>
    <option class="data-type" value="children">Children</option>
    <option class="data-type" value="injuries">Injuries</option>
  </select>
</div>
<div class="text" id="intro">
  <h1>Death from Above</h1>
  <p>Mapping deaths from drone strikes.</p>
</div>

<div class="section" id="timeline-section">
  <!--

  * x axis: time
  * y axis: country

  * stack each country's timeline, plot each strike along its x axis
  * have control to toggle radius scaled to magnitude of each strike
  * able to switch datasets to display deaths_max, deaths_min, civilians, children

   -->
  <h2>By Country</h2>
  <p>Each circle corresponds to a single strike.</p>
  <div class="timeline-by-country"></div>
</div>
<div class="section" id="map-section">
  <h2>By Latitude, Longitude</h2>
  <p>Hover over the timeline to learn about each individual strike. You can also click on the strikes to zoom into each region.</p>
  <div class="timeline"></div>
  <div class="map"></div>
</div>
<script src="javascripts/d3.v3.min.js"></script>
<script src="javascripts/topojson.v1.min.js"></script>
<script src="javascripts/d3.geo.projection.v0.min.js"></script>
<script src="javascripts/jquery-1.11.0.min.js"></script>
<script src="javascripts/d3.tip.v0.6.3.js"></script>

<script>

// Global variables

var width = $(".map").width(),
    height = $(".map").height(),
    padding = {top: 10, right: 20, bottom: 25, left: 20},
    active = d3.select(null),
    midLon = 56.9117872504883,
    midLat = 17.35921249538195,
    selectedDataType = "deaths_max",
    transitionTime = 1000

// TODO fix assignment of midLon, midLat
// projection is finishing before the assignment is finished...

// d3.json("data/drones.json", function(error, json) {
//   dataset = json.strike
//   var maxLon = d3.max(dataset, function(d) { return d.lon })
//   var minLon = d3.min(dataset, function(d) { return d.lon })
//   var maxLat = d3.max(dataset, function(d) { return d.lat })
//   var minLat = d3.min(dataset, function(d) { return d.lat })
  
//   midLon = (parseFloat(maxLon) + parseFloat(minLon)) / 2
//   midLat = (parseFloat(maxLat) + parseFloat(minLat)) / 2
// })






// Map variables

var projection = d3.geo.kavrayskiy7()
    .center([midLon, midLat])
    .scale(600)

var zoom = d3.behavior.zoom()
    .translate([0, 0])
    .scale(1)
    .scaleExtent([1, 8])
    .on("zoom", zoomed);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select(".map").append("svg")
    .attr("width", width)
    .attr("height", height)

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", reset);

var g = svg.append("g")


//// TODO actually implement tooltips
var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
    console.log("test");
    return "<strong>Frequency:</strong> <span style='color:red'>" + d[selectedDataType] + "</span>";
  })
//// TODO actually implement tooltips
g.call(tip)

svg.call(zoom.event);

// Draw Map
d3.json("data/readme-world-names.json", function(error, world) {
  var countries = topojson.feature(world, world.objects.countries).features
  g.selectAll("path")
      .data(countries)
    .enter().append("path")
      .attr("d", path)
      .attr("class", "feature")
      .attr("id", function(d) { return d.id.replace(" ", "-") })
      .on("click", clicked)

  g.append("path")
      .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
      .attr("class", "mesh")
      .attr("d", path);

  // TODO make the country the country-name's parent node...
  // Label country names
  g.selectAll(".country-name")
    .data(countries)
  .enter().append("text")
    .attr("class", function(d) { return "country-name" })
    .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
    .attr("dx", "-1.5em")
    .text(function(d) { return d.id; });
})

// Click handler for map
function clicked(d) {
  if (active.node() === this || jQuery.inArray(d.id, affectedCountries) == -1) {
    return reset()
  }

  active.classed("active", false);
  active = d3.select(this).classed("active", true);
  
  var bounds = path.bounds(d),
      dx = bounds[1][0] - bounds[0][0],
      dy = bounds[1][1] - bounds[0][1],
      x = (bounds[0][0] + bounds[1][0]) / 2,
      y = (bounds[0][1] + bounds[1][1]) / 2,
      scale = .9 / Math.max(dx / width, dy / height),
      translate = [width / 2 - scale * x, height / 2 - scale * y],
      circleScaleValue = 1 / scale

  svg.transition()
      .duration(transitionTime)
      .call(zoom.translate(translate).scale(scale).event)

  // Scale circles on zoom
  scaleCircles(circleScaleValue)

  // Fade out the strikes in the timeline not in country
  var selector = ".timeline-circle:not(.timeline-" + d.id.replace(" ", "-") + ")"

  // $(selector).attr("class", ($(selector).attr("class") + " not-applicable"))
  $(selector).css("opacity", 0)
  // $(".timeline-" + d.id.replace(" ", "-")).css("opacity", circleOpacityDefault)
}

// Scale circles on map
function scaleCircles(circleScaleValue) {
  g.selectAll(".strike")
    .transition()
    .duration(transitionTime)
    // .attr("r", function(d) { if(!isNumber(d[selectedDataType])) { return 0 } return yScale(d[selectedDataType]) * circleScaleValue })
    .attr("r", function(d) { if(!isNumber(d[selectedDataType])) { return 0 } return d[selectedDataType] * circleScaleValue })
  
  // g.selectAll(".feature")
  //   .transition()
  //   .duration(transitionTime)
  //   .style("opacity", opacityValue)

  // g.selectAll(".feature.active")
  //   .transition()
  //   .duration(transitionTime)
  //   .style("opacity", 1)
}

// Dispatches click event for d3 objects
jQuery.fn.d3Click = function () {
  this.each(function (i, e) {
    var evt = document.createEvent("MouseEvents")
    evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null)
    e.dispatchEvent(evt);
  })
}

// Resets map back to default state
function reset() {
  // Scale circles
  scaleCircles(1)
  
  // Reset node thing
  active.classed("active", false);
  active = d3.select(null);

  // Reset opacity
  $("circle.timeline-circle").css("opacity", circleOpacityDefault)
  $("circle.strike").css("opacity", circleOpacityDefault)

  // Reset zoom
  svg.transition()
      .duration(transitionTime)
      .call(zoom.translate([0, 0]).scale(1).event);
}

// Zoom behaviour 
function zoomed() {
  g.style("stroke-width", 1.5 / d3.event.scale + "px");
  g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}

// Set the max radius for the strikes
var radiusMax = 50,
    circleOpacityHighlight = 0.5,
    circleOpacityDefault = 0.2,
    circleOpacitySuppressed = 0.05,
    strikesOnMap

// Checks if input is a number
function isNumber(n){
  return typeof(n) != "boolean" && !isNaN(n);
}

// Store array of affected countries to check against later
var affectedCountries = []

// Draw circles on map
d3.json("data/drones.json", function(error, json) {
  dataset = json.strike
  yScale = d3.scale.linear()
        .domain([0, d3.max(dataset, function(d) { if(isNumber(d[selectedDataType])) { return parseInt(d[selectedDataType]) } else { return 0 } })])
        .range([5, radiusMax])


  strikesOnMap = g.selectAll("circle")
    .data(dataset)
    .enter()
    .append("circle")
      .attr("class", "strike")
      .attr("id", function(d) { if (jQuery.inArray(d.country, affectedCountries) == -1) { affectedCountries.push(d.country) } ; return d._id })
      // .attr("r", function(d) { if(!isNumber(d[selectedDataType])) { return 0 } return yScale(d[selectedDataType]) } )
      .attr("r", function(d) { if(!isNumber(d[selectedDataType])) { return 0 } return d[selectedDataType] } )
      .attr("transform", function(d) { return "translate(" + projection([d.lon, d.lat]) + ")" } )
      .on("click", function(d) { return $("#" + d.country.replace(" ", "-")).d3Click() } )
      //// TODO actually implement tooltips
      .on("mouseover", function(d) { tip.show; highlightStrike(d._id, d.country) } )
      .on("mouseout", function(d) { tip.hide; fadeInStrikes(d.country)} )
})

function highlightStrike(id, country) {
  var selector = ".timeline-" + country.replace(" ", "-")
  $("circle.strike").css("opacity", circleOpacitySuppressed)
  $("circle#" + id).css("opacity", circleOpacityHighlight)
  $(selector).css("opacity", circleOpacitySuppressed)
  $("circle#timeline-" + id).css("opacity", circleOpacityHighlight)
}

function fadeInStrikes(country) {
  var selector = ".timeline-" + country.replace(" ", "-")
  $("circle.strike").css("opacity", circleOpacityDefault)
  $(selector).css("opacity", circleOpacityDefault)
}

function resetOpacity() {
  $("circle.timeline-circle").css("opacity", circleOpacityDefault)
  $("circle.strike").css("opacity", circleOpacityDefault)
}

// Timeline variables
var timelineWidth = $(".timeline").width(),
    timelineHeight = $(".timeline").height(), 
    xScale,
    timeline,
    dataset,
    strikesOnTimeline

timeline = d3.select(".timeline").append("svg")
        .attr("width", timelineWidth)
        .attr("height", timelineHeight)

// Set up timeline
d3.json("data/drones.json", function(error, json) {
  dataset = json.strike
  xScale = d3.time.scale()
          .domain([new Date(dataset[0].date), new Date(dataset[dataset.length - 1].date)])
          .range([padding.left, width - padding.right])

  strikesOnTimeline = timeline.selectAll("circle")
    .data(dataset)
    .enter()
    .append("circle")
    .attr("class", function(d) { return ("timeline-circle timeline-" + d.country) })
    .attr("id", function(d) { return "timeline-" + d._id })
    .attr("r", 3)
    .attr("cx", function(d) { return xScale(new Date(d.date)) })
    .attr("cy", 18)
    .on("mouseover", function(d) { return highlightStrike(d._id, d.country) } )
    .on("mouseout", function(d) { fadeInStrikes() } )
    .on("click", function(d) { return $("#" + d.country.replace(" ", "-")).d3Click() } )

  // Define and draw x-axis
  var xAxis = d3.svg.axis()
    .scale(xScale)
    .orient("top")
    .ticks(10)

  timeline.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(10," + (timelineHeight - padding.top) + ")")
    .call(xAxis)
})

// TODO Change data type on change event
// how to call change
// http://bl.ocks.org/mbostock/3943967

// join/update/exit
// part 1
// http://bl.ocks.org/mbostock/3808218
// part 2
// http://bl.ocks.org/mbostock/3808221
// part 3
// http://bl.ocks.org/mbostock/3808234

d3.select(".data-type-selector").on("change", change)

// TODO Change data types
function change() {
  // Get new data type
  selectedDataType = $(".data-type-selector").val()

  // Shrink circles for old data
  // Animate in new data

  // Join new data
  var strikesOnMapNew = strikesOnMap
    .data(function(d) { d[selectedDataType] })

  strikesOnMapNew

  strikesOnMap.transition()
    .duration(transitionTime)
    .attr("r", function(d) {  } )
}


/*

Timeline per country

*/

d3.json("data/drones.json", function(error, json) {
  dataset = json.strike
  xScale = d3.time.scale()
          .domain([new Date(dataset[0].date), new Date(dataset[dataset.length - 1].date)])
          .range([padding.left, width - padding.right])


  
  // Define and draw x-axis
  var xAxis = d3.svg.axis()
    .scale(xScale)
    .orient("top")
    .ticks(10)

  // timeline.append("g")
  //   .attr("class", "axis")
  //   .attr("transform", "translate(10," + (timelineHeight - padding.top) + ")")
  //   .call(xAxis)
})



</script>
