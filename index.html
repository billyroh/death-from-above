<!DOCTYPE html>
<meta charset="utf-8">
<title>Death from Above</title>
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0 auto;
  padding: 60px;
  max-width: 1000px;
  min-width: 320px;
}

h1, h2 {
  font-weight: 300;
}

h1, h2, p {
  text-align: center;
}

.map {
  width: 100%;
  height: 600px;
  display: block;
  border: 1px solid rgba(0, 0, 0, 0.3);
}

.timeline {
  width: 100%;
  height: 30px;
  margin-top: 10px;
}

.country {
  fill: #ccc;
  stroke: #fff;
  stroke-width: .5px;
  stroke-linejoin: round;
}

circle {
  fill: rgba(200, 18, 18, 0.2);
}

.country-name {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  fill: #000;
  opacity: 0.3;
  margin-left: -10px;
  font-size: 11px;
  text-transform: uppercase;
  cursor: default;
}

.axis path,
.axis line {
  fill: none;
  stroke: black;
  shape-rendering: crispEdges;
}

.axis path {
  stroke: none;
}

.axis text {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 11px;
  cursor: default;
}

</style>
<body>
<script src="javascripts/d3.v3.min.js"></script>
<script src="javascripts/d3.geo.projection.v0.min.js"></script>
<script src="javascripts/topojson.js"></script>
<script src="javascripts/jquery-1.11.0.min.js"></script>
<div class="text" id="intro">
  <h1>Death from Above</h1>
  <p>Mapping deaths from drone strikes.</p>
</div>
<div class="section">
  <h2>Section Title</h2>
  <p>Hover over the timeline to learn about each individual strike. You can also click on the strikes to zoom into each region.</p>
  <div class="map"></div>
  <div class="timeline"></div>
</div>
<script>

//// Set up map
var width = $(".map").width(),
    height = $(".map").height(),
    centered,
    padding = {top: 10, right: 20, bottom: 25, left: 20}

var projection = d3.geo.kavrayskiy7()
    .center([37, 33])
    .scale(750)
    .translate([width / 3.5, height / 5])

var path = d3.geo.path()
    .projection(projection)

var map = d3.select(".map").append("svg")
    .attr("width", width)
    .attr("height", height)

var zoom = d3.behavior.zoom()
    .translate([0, 0])
    .scale(1)
    .scaleExtent([1,8])

var g = map.append("g")

map.call(zoom.event)

// Store the centroids for each country
var countryCentroids = []

// Draw map
d3.json("data/readme-world-names.json", function(error, world) {
  var countries = topojson.feature(world, world.objects.countries).features,
      neighbors = topojson.neighbors(world.objects.countries.geometries)

  // Draw countries
  g.selectAll("path")
      .data(countries)
    .enter().append("path")
      .attr("d", path)
      .attr("class", "country")
      .on("click", clicked)

  // Label country names
  g.selectAll(".country-name")
    .data(countries)
  .enter().append("text")
    .attr("class", function(d) { return "country-name"; })
    .attr("transform", function(d) { countryCentroids.push([d.id, path.centroid(d)]); return "translate(" + (path.centroid(d)[0] - 18) + ", " + path.centroid(d)[1] + ")"; })
    .attr("dy", ".35em")
    .text(function(d) { return d.id; });

})

// Set the max radius for the strikes
var radiusMax = 60

function isNumber(n){
  return typeof(n) != "boolean" && !isNaN(n);
}

// Drone data
d3.json("data/drones.json", function(error, json) {
  dataset = json.strike
  yScale = d3.scale.linear()
        .domain([0, d3.max(dataset, function(d) { if(isNumber(d.deaths_max)) { return parseInt(d.deaths_max) } else { return 0 } })])
        .range([0, radiusMax])

  // Draw circles on map
  g.selectAll(".circles")
    .data(dataset)
    .enter()
    .append("circle")
    .attr("class", "strike")
    .attr("r", function(d) { if(!isNumber(d.deaths_max)) { return 0 } return yScale(d.deaths_max) } )
    .attr("transform", function(d) { return "translate(" + projection([d.lon, d.lat]) + ")" } )
    .on("click", function(d) { return clicked(d) })

})

// Tweening between projections
// Source: http://bl.ocks.org/mbostock/3711652
function projectionTween(projection0, projection1) {
  return function(d) {
    var t = 0;

    var projection = d3.geo.projection(project)
        .scale(1)
        .translate([width / 2, height / 2]);

    var path = d3.geo.path()
        .projection(projection);

    function project(λ, φ) {
      λ *= 180 / Math.PI, φ *= 180 / Math.PI;
      var p0 = projection0([λ, φ]), p1 = projection1([λ, φ]);
      return [(1 - t) * p0[0] + t * p1[0], (1 - t) * -p0[1] + t * -p1[1]];
    }

    return function(_) {
      t = _;
      return path(d);
    };
  };
}

var zoomed = false

// Read this maybe? http://www.d3noob.org/2014/03/leaflet-map-with-d3js-elements-that-are.html
// http://bl.ocks.org/d3noob/5193723
// TODO Click to zoom...
function clicked(strike) {
  var x,
      y,
      k = 3,
      country = strike.country,
      xScaleZoom = d3.scale.linear().range([0, width]).domain([strike.x, strike.x + strike.dx]),
      yScaleZoom = d3.scale.linear().range([0, height]).domain([strike.y, strike.y + strike.dy]),
      newProjection

  zoomed = !zoomed

  // Get country name
  // Get country's centroid
  for (var i = 0; i < countryCentroids.length; i++) {
    if (countryCentroids[i][0] == country) {
      x = countryCentroids[i][1][0]
      y = countryCentroids[i][1][1] - 80
    }
  }

  var transitionTime = 750

  g.transition()
    .duration(transitionTime)
    // .attr("d", projectionTween(projection, newProjection))
    .attr("transform", "translate(" + width / 2 + ", " + height / 2 + ")scale(" + k + ")translate(" + -x +  ", " + -y + ")")

  // Names
  g.selectAll(".country-name")
    .transition()
    .duration(transitionTime / 5)
    .style("opacity", 0)

  var circleScaleValue = (1 / k)
  if (!zoomed) {
    circleScaleValue = 1
  }

  g.selectAll(".strike")
    .transition()
    .duration(transitionTime)
    .attr("r", function(d) { if(!isNumber(d.deaths_max)) { return 0 } return yScale(d.deaths_max) * circleScaleValue })

}

//// Timeline

var width = $(".timeline").width(),
    height = $(".timeline").height(), 
    xScale,
    timeline,
    dataset

timeline = d3.select(".timeline").append("svg")
        .attr("width", width)
        .attr("height", height)

d3.json("data/drones.json", function(error, json) {
  dataset = json.strike
  xScale = d3.time.scale()
          .domain([new Date(dataset[0].date), new Date(dataset[dataset.length - 1].date)])
          .range([padding.left, width - padding.right])

  timeline.selectAll("circle")
    .data(dataset)
    .enter()
    .append("circle")
    .attr("r", 3)
    .attr("cx", function(d) { return xScale(new Date(d.date)) })
    .attr("cy", 5)

  // Define and draw x-axis
  var xAxis = d3.svg.axis()
    .scale(xScale)
    .orient("bottom")
    .ticks(10)

  timeline.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(10," + (height - padding.bottom) + ")")
    .call(xAxis)
})

</script>
</body>